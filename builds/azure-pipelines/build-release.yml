trigger: none

pr: none

schedules:
  - cron: "0 0 * * *"
    displayName: Mon-Fri at Midnight
    branches:
      include:
        - main
    always: true

variables:
  solution: '**/*.sln'
  configuration: 'Release'
  versionMajor: 0
  versionMinor: 1
  versionPatch: $[counter(variables['versionMinor'], 0)] # This will reset when we bump minor version
  nugetVersion: '$(versionMajor).$(versionMinor).$(versionPatch)-preview'

stages:
- stage: BuildPublish
  displayName: 'Release Build and Publish'

  jobs:
  - job: BuildTestPublish
    displayName: 'Release: Build, Test and Publish'

  # Verifies cross-platform build and test
    strategy:
      matrix:
        mac:
          imageName: 'macos-latest'
          # Disabling integration tests on macOS due to issues with running MSSQL on Docker
          # We need to set up a self-hosted agent with Docker running by default: https://github.com/microsoft/azure-pipelines-tasks/issues/12823
          testFilter: '--filter FullyQualifiedName!~Integration'
          testServer: ''
        windows:
          imageName: 'windows-latest'
          testFilter: ''
          testServer: '(LocalDb)\MSSQLLocalDB'
        linux:
          imageName: 'ubuntu-latest'
          testFilter: ''
          testServer: ''

    pool:
      vmImage: '$(imageName)'

    workspace:
      clean: all

    steps:
      - template: 'template-steps-build-test.yml'
        parameters:
          solution: '$(solution)'
          configuration: '$(configuration)'
          nugetVersion: '$(nugetVersion)'
          testFilter: '$(testFilter)'

      - ${{ if eq(variables['Agent.OS'], 'linux') }}:
        - template: 'template-steps-publish.yml'
          parameters:
            configuration: '$(configuration)'
